<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Punch</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,system-ui,"Segoe UI",sans-serif;background:#f5f5f5;margin:0;padding:16px}
    .card{max-width:720px;margin:0 auto;background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:16px}
    h1{margin:0 0 8px 0;text-align:center;font-size:20px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:13px}
    .ok{background:#e8f5e9}
    .bad{background:#ffebee}
    .mid{background:#e3f2fd}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0}
    button{flex:1;min-width:140px;padding:14px 14px;border:0;border-radius:999px;font-size:16px}
    button:disabled{opacity:.5}
    .in{background:#2e7d32;color:#fff}
    .out{background:#c62828;color:#fff}
    .break{background:#1565c0;color:#fff}
    .muted{color:#666;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;white-space:nowrap}
    .footer{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .smallbtn{flex:none;min-width:auto;padding:10px 12px;font-size:13px;background:#1976d2;color:#fff}
    .warn{margin-top:10px;padding:10px;border-radius:12px;background:#fff8e1;font-size:13px}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Time Punch</h1>

    <div class="row" style="justify-content:space-between">
      <div>
        Status:
        <span id="status" class="pill bad">Loading…</span>
      </div>
      <div class="muted" id="today"></div>
    </div>

    <div class="row">
      <button id="btnIn" class="in">Punch In</button>
      <button id="btnOut" class="out" disabled>Punch Out</button>
    </div>

    <div class="row">
      <button id="btnBreakStart" class="break" disabled>Start Meal Break</button>
      <button id="btnBreakEnd" class="break" disabled>End Meal Break</button>
    </div>

    <div class="row" style="justify-content:space-between">
      <div><strong>Total Net Hours Today:</strong> <span id="total">0.00</span></div>
      <div class="muted" id="since"></div>
    </div>

    <table>
      <thead>
        <tr><th>In</th><th>Break</th><th>Out</th><th>Break Min</th><th>Net Hours</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer">
      <button id="export" class="smallbtn">Export CSV</button>
      <button id="clear" class="smallbtn">Clear Today</button>
    </div>

    <div class="warn">
      <div><strong>iPhone note:</strong> If buttons don’t work, open in Safari:</div>
      <ol>
        <li>Tap Share → <strong>Open in Safari</strong></li>
        <li>Then Share → <strong>Add to Home Screen</strong></li>
      </ol>
      <div class="muted" id="diag"></div>
    </div>
  </div>

<script>
(function(){
  function canUseLocalStorage(){
    try{
      const k="__tp_test__";
      localStorage.setItem(k,"1");
      localStorage.removeItem(k);
      return true;
    }catch(e){ return false; }
  }

  const HAS_LS = canUseLocalStorage();
  const memStore = { entries: [] };
  const STORE_KEY = "timePunchEntries_v3_break";

  function loadAll(){
    if(HAS_LS){
      const raw = localStorage.getItem(STORE_KEY);
      return raw ? JSON.parse(raw) : [];
    }
    return memStore.entries;
  }
  function saveAll(entries){
    if(HAS_LS){
      localStorage.setItem(STORE_KEY, JSON.stringify(entries));
    }else{
      memStore.entries = entries;
    }
  }

  const $ = (id)=>document.getElementById(id);
  const statusEl = $("status");
  const todayEl = $("today");
  const sinceEl = $("since");
  const totalEl = $("total");
  const tbody = $("tbody");
  const btnIn = $("btnIn");
  const btnOut = $("btnOut");
  const btnBreakStart = $("btnBreakStart");
  const btnBreakEnd = $("btnBreakEnd");
  const diagEl = $("diag");

  function pad2(n){ return String(n).padStart(2,"0"); }

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    return `${yyyy}-${mm}-${dd}`;
  }

  function fmtTime(d){
    return d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});
  }

  function fmtDate(d){
    return d.toLocaleDateString(undefined,{weekday:"short",year:"numeric",month:"short",day:"numeric"});
  }

  function getOpenEntry(entries){
    return entries.find(e => !e.out);
  }

  function getTodayEntries(entries){
    const t = todayISO();
    return entries.filter(e => e.date === t);
  }

  function breakMinutes(entry){
    if(entry.break_start && entry.break_end){
      return Math.max(0, Math.round((new Date(entry.break_end) - new Date(entry.break_start)) / 60000));
    }
    return 0;
  }

  function netHours(entry){
    if(!entry.out) return null;
    const inD = new Date(entry.in);
    const outD = new Date(entry.out);
    const totalMs = Math.max(0, outD - inD);
    const bMin = breakMinutes(entry);
    const netMs = Math.max(0, totalMs - (bMin * 60000));
    return netMs / (1000*60*60);
  }

  function setStatus(open){
    if(!open){
      statusEl.textContent = "Off the clock";
      statusEl.className = "pill bad";
      return;
    }
    if(open.break_start && !open.break_end){
      statusEl.textContent = "On meal break";
      statusEl.className = "pill mid";
      return;
    }
    statusEl.textContent = "On the clock";
    statusEl.className = "pill ok";
  }

  function render(){
    const all = loadAll();
    todayEl.textContent = fmtDate(new Date());

    const open = getOpenEntry(all);
    setStatus(open);

    // Button logic
    const onClock = !!open;
    const onBreak = !!(open && open.break_start && !open.break_end);

    btnIn.disabled = onClock;
    btnOut.disabled = !onClock || onBreak; // require ending break before punch out

    btnBreakStart.disabled = !onClock || onBreak || (open && open.break_end); // one break per shift
    btnBreakEnd.disabled = !onBreak;

    sinceEl.textContent = open ? ("Clocked in since " + fmtTime(new Date(open.in))) : "";

    // Table
    const todays = getTodayEntries(all);
    tbody.innerHTML = "";

    let totalNet = 0;
    for(const e of todays){
      const tr = document.createElement("tr");

      const tdIn = document.createElement("td");
      tdIn.textContent = fmtTime(new Date(e.in));

      const tdBreak = document.createElement("td");
      if(e.break_start && e.break_end){
        tdBreak.textContent = fmtTime(new Date(e.break_start)) + "–" + fmtTime(new Date(e.break_end));
      }else if(e.break_start && !e.break_end){
        tdBreak.textContent = fmtTime(new Date(e.break_start)) + "–…";
      }else{
        tdBreak.textContent = "—";
      }

      const tdOut = document.createElement("td");
      tdOut.textContent = e.out ? fmtTime(new Date(e.out)) : "—";

      const tdBMin = document.createElement("td");
      tdBMin.textContent = (e.break_start ? breakMinutes(e) : 0).toString();

      const tdNet = document.createElement("td");
      const nh = netHours(e);
      if(nh === null){
        tdNet.textContent = "—";
      }else{
        tdNet.textContent = nh.toFixed(2);
        totalNet += nh;
      }

      tr.appendChild(tdIn);
      tr.appendChild(tdBreak);
      tr.appendChild(tdOut);
      tr.appendChild(tdBMin);
      tr.appendChild(tdNet);
      tbody.appendChild(tr);
    }

    totalEl.textContent = totalNet.toFixed(2);

    // Diagnostics
    diagEl.innerHTML =
      "Diagnostics:" +
      "<br>• JavaScript: <span class='pill ok'>Running</span>" +
      "<br>• localStorage: " + (HAS_LS ? "<span class='pill ok'>Available</span>" : "<span class='pill bad'>Blocked</span> (won’t save after closing)") +
      "<br>• Today key: <code>" + todayISO() + "</code>";
  }

  function punchIn(){
    const all = loadAll();
    if(getOpenEntry(all)){
      alert("Already punched in. Please punch out first.");
      return;
    }
    const now = new Date();
    all.push({
      date: todayISO(),
      in: now.toISOString(),
      out: null,
      break_start: null,
      break_end: null
    });
    saveAll(all);
    render();
  }

  function startBreak(){
    const all = loadAll();
    const open = getOpenEntry(all);
    if(!open){
      alert("You must be punched in first.");
      return;
    }
    if(open.break_start){
      alert("Meal break already used for this shift.");
      return;
    }
    open.break_start = new Date().toISOString();
    open.break_end = null;
    saveAll(all);
    render();
  }

  function endBreak(){
    const all = loadAll();
    const open = getOpenEntry(all);
    if(!open || !open.break_start || open.break_end){
      alert("No active meal break found.");
      return;
    }
    open.break_end = new Date().toISOString();
    saveAll(all);
    render();
  }

  function punchOut(){
    const all = loadAll();
    const open = getOpenEntry(all);
    if(!open){
      alert("No active punch-in found.");
      return;
    }
    if(open.break_start && !open.break_end){
      alert("End your meal break before punching out.");
      return;
    }
    open.out = new Date().toISOString();
    saveAll(all);
    render();
  }

  function clearToday(){
    if(!confirm("Clear today's entries? This cannot be undone.")) return;
    const all = loadAll();
    const t = todayISO();
    saveAll(all.filter(e => e.date !== t));
    render();
  }

  function exportCSV(){
    const all = loadAll();
    if(!all.length){
      alert("No entries to export.");
      return;
    }
    let csv = "Date,In,Break Start,Break End,Out,Break Minutes,Net Hours\n";
    for(const e of all){
      const inD = new Date(e.in);
      const outStr = e.out ? new Date(e.out).toISOString() : "";
      const bs = e.break_start ? new Date(e.break_start).toISOString() : "";
      const be = e.break_end ? new Date(e.break_end).toISOString() : "";
      const bmin = e.break_start ? breakMinutes(e) : 0;
      const nh = (e.out ? netHours(e).toFixed(2) : "");
      csv += [e.date, inD.toISOString(), bs, be, outStr, bmin, nh].join(",") + "\n";
    }
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "time_log.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  window.addEventListener("DOMContentLoaded", function(){
    btnIn.addEventListener("click", punchIn);
    btnOut.addEventListener("click", punchOut);
    btnBreakStart.addEventListener("click", startBreak);
    btnBreakEnd.addEventListener("click", endBreak);
    $("clear").addEventListener("click", clearToday);
    $("export").addEventListener("click", exportCSV);
    render();
  });
})();
</script>
</body>
</html>
